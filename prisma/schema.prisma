generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Agent: An AI agent registered on the platform
model Agent {
  id              String   @id @default(uuid())
  name            String
  description     String?
  apiKey          String   @unique

  // On-chain identity (ERC-7857 iNFT on 0G Chain)
  inftTokenId     String?  @unique

  // Claim flow (builder claims ownership later)
  claimCode       String?  @unique  // Secret code for claiming (arena_claim_xxx)
  claimCodeHash   String?           // Keccak256 hash for on-chain verification
  claimed         Boolean  @default(false)
  claimedAt       DateTime?
  claimedBy       String?           // Builder's wallet address after claiming

  // Stats
  wins            Int      @default(0)
  losses          Int      @default(0)
  draws           Int      @default(0)
  eloRating       Int      @default(1200)
  bestClickCount  Int?

  createdAt       DateTime @default(now())

  // Relations
  matchesAsAgent1 Match[]  @relation("Agent1")
  matchesAsAgent2 Match[]  @relation("Agent2")
  matchesWon      Match[]  @relation("Winner")
}

// CompetitionType: A catalog of available competition formats
model CompetitionType {
  id               String  @id @default(uuid())
  slug             String  @unique       // e.g. "wikipedia-speedrun"
  name             String               // e.g. "Wikipedia Speedrun"
  description      String
  prompts          String               // JSON: [{startArticle, targetArticle}]
  timeLimitSeconds Int     @default(300)
  active           Boolean @default(true)
  matches          Match[]

  createdAt        DateTime @default(now())
}

// Match: A 1v1 browser agent competition
model Match {
  id              String   @id @default(uuid())

  // Status: waiting_for_opponent | active | judging | complete | cancelled
  status          String   @default("waiting_for_opponent")

  // Competition type reference
  competitionTypeId String?
  competitionType   CompetitionType? @relation(fields: [competitionTypeId], references: [id])

  // Competition details (denormalized from CompetitionType + selected prompt)
  taskDescription String   @default("")  // e.g. "Wikipedia Speedrun: Navigate from Capybara to Philosophy"
  startUrl        String   @default("")  // e.g. "https://en.wikipedia.org/wiki/Capybara"
  targetArticle   String   @default("")  // e.g. "Philosophy"
  timeLimitSeconds Int     @default(300)

  // Participants (1v1)
  agent1Id        String?
  agent1          Agent?   @relation("Agent1", fields: [agent1Id], references: [id])
  agent2Id        String?
  agent2          Agent?   @relation("Agent2", fields: [agent2Id], references: [id])

  // Tracking
  agent1Clicks    Int      @default(0)
  agent2Clicks    Int      @default(0)
  agent1LastUrl   String?
  agent2LastUrl   String?

  // Oracle verdict (JSON)
  oracleVerdict   String?

  // Result
  winnerId        String?
  winner          Agent?   @relation("Winner", fields: [winnerId], references: [id])

  // Timing
  startedAt       DateTime?
  endsAt          DateTime?
  completedAt     DateTime?

  createdAt       DateTime @default(now())
}
